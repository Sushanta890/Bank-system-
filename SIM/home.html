<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>S.K SIM Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
    --bg:#0f2027;
    --card:#263238;
    --text:#fff;
    --accent:#00e6ff;
    --out:#004d40;
}
.light{
    --bg:#f5f5f5;
    --card:#fff;
    --text:#000;
    --accent:#1976d2;
    --out:#c8e6c9;
}
body{
    margin:0;
    background:var(--bg);
    font-family:Segoe UI;
    color:var(--text);
}
.header{
    background:#111;
    padding:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
button{
    border:none;
    padding:8px 10px;
    border-radius:6px;
    background:var(--accent);
    font-weight:bold;
    cursor:pointer;
}
.nav{
    display:flex;
    gap:6px;
    padding:8px;
}
.nav button{flex:1}
.box{padding:10px}

.msg{
    max-width:75%;
    padding:10px;
    margin:6px 0;
    border-radius:10px;
    animation:fade .2s;
    cursor:pointer;
}
.in{background:var(--card)}
.out{background:var(--out);margin-left:auto}

.selected{
    outline:3px solid red;
}

@keyframes fade{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1}
}

.chatBar{
    display:flex;
    gap:6px;
    margin-top:8px;
}
.chatBar input{
    flex:1;
    padding:10px;
    border-radius:8px;
    border:none;
}
.counter{
    background:red;
    color:#fff;
    padding:2px 6px;
    border-radius:10px;
    font-size:12px;
}
small{opacity:.7}
</style>
</head>

<body>

<div class="header">
    <div>
        <b>S.K SIM</b><br>
        <span id="mysim"></span>
    </div>
    <div>
        <button onclick="toggleMode()">üåô</button>
        <button onclick="logout()">Logout</button>
    </div>
</div>

<div class="nav">
    <button onclick="home()">üè† Home</button>
    <button onclick="chatList()">üí¨ Chats <span id="count" class="counter"></span></button>
</div>

<div class="box" id="content"></div>

<script>
/* ===== GLOBALS ===== */
const content = document.getElementById("content");
const mySIM = localStorage.getItem("activeSIM") || "0000000000";
document.getElementById("mysim").textContent = "SIM: " + mySIM;

let currentChatSIM = null;
let selectedMsg = null;
let selectedType = null;

/* ===== MODE ===== */
let mode = localStorage.getItem("mode") || "dark";
if(mode === "light") document.body.classList.add("light");

function toggleMode(){
    document.body.classList.toggle("light");
    localStorage.setItem("mode",
        document.body.classList.contains("light") ? "light" : "dark");
}

/* ===== LOGOUT ===== */
function logout(){
    localStorage.removeItem("activeSIM");
    location.href="login.html";
}

/* ===== HOME ===== */
function home(){
    content.innerHTML=`
        <b>Welcome to S.K SIM Chat</b><br><br>
        üí¨ WhatsApp style chat<br>
        üîî Live notifications<br>
        üóë Select & delete messages<br>
        üåô Dark / Light mode
    `;
}

/* ===== UNREAD COUNT ===== */
function unreadCount(){
    const inbox = JSON.parse(localStorage.getItem("inbox_"+mySIM))||[];
    document.getElementById("count").textContent = inbox.length || "";
}
unreadCount();

/* ===== CHAT LIST ===== */
function chatList(){
    const inbox = JSON.parse(localStorage.getItem("inbox_"+mySIM))||[];
    content.innerHTML="<b>Chats</b><br>";

    if(!inbox.length){
        content.innerHTML += "<small>No messages</small>";
        return;
    }

    const unique = [...new Set(inbox.map(m=>m.from))];
    unique.forEach(sim=>{
        const d=document.createElement("div");
        d.className="msg in";
        d.innerHTML=`<b>${sim}</b><br><small>Tap to open</small>`;
        d.onclick=()=>openChat(sim);
        content.appendChild(d);
    });
}

/* ===== OPEN CHAT ===== */
function openChat(sim){
    currentChatSIM = sim;
    content.innerHTML=`
        <b>Chat with ${sim}</b>
        <div id="chat"></div>

        <div class="chatBar">
            <input id="msg" placeholder="Type message">
            <button onclick="send('${sim}')">Send</button>
        </div>

        <button style="margin-top:6px;background:red;color:#fff"
                onclick="deleteMsg()">Delete Selected</button>
    `;
    loadChat(sim);
}

/* ===== LOAD CHAT ===== */
function loadChat(sim){
    const chat=document.getElementById("chat");
    chat.innerHTML="";

    const inbox=JSON.parse(localStorage.getItem("inbox_"+mySIM))||[];
    inbox.filter(m=>m.from===sim).forEach(m=>{
        chat.innerHTML+=`
            <div class="msg in"
                onclick="selectMsg(this,'inbox','${m.id}')">
                ${m.text}<br><small>${m.time}</small>
            </div>`;
    });

    const sent=JSON.parse(localStorage.getItem("sent_"+mySIM))||[];
    sent.filter(m=>m.to===sim).forEach(m=>{
        chat.innerHTML+=`
            <div class="msg out"
                onclick="selectMsg(this,'sent','${m.id}')">
                ${m.text}<br><small>${m.time}</small>
            </div>`;
    });
}

/* ===== SELECT MESSAGE ===== */
function selectMsg(el,type,id){
    document.querySelectorAll(".msg").forEach(m=>m.classList.remove("selected"));
    el.classList.add("selected");
    selectedMsg=id;
    selectedType=type;
}

/* ===== SEND MESSAGE ===== */
function send(to){
    const text=document.getElementById("msg").value.trim();
    if(!text) return;

    const time=new Date().toLocaleTimeString();

    const inboxMsg={
        id:crypto.randomUUID(),
        from:mySIM,
        text,
        time
    };

    const sentMsg={
        id:crypto.randomUUID(),
        to,
        text,
        time
    };

    const inboxKey="inbox_"+to;
    const inbox=JSON.parse(localStorage.getItem(inboxKey))||[];
    inbox.push(inboxMsg);
    localStorage.setItem(inboxKey,JSON.stringify(inbox));

    const sentKey="sent_"+mySIM;
    const sent=JSON.parse(localStorage.getItem(sentKey))||[];
    sent.push(sentMsg);
    localStorage.setItem(sentKey,JSON.stringify(sent));

    openChat(to);
}

/* ===== DELETE MESSAGE ===== */
function deleteMsg(){
    if(!selectedMsg || !selectedType){
        alert("Select a message first");
        return;
    }

    const key = selectedType==="inbox"
        ? "inbox_"+mySIM
        : "sent_"+mySIM;

    let data=JSON.parse(localStorage.getItem(key))||[];
    data=data.filter(m=>m.id!==selectedMsg);
    localStorage.setItem(key,JSON.stringify(data));

    selectedMsg=null;
    selectedType=null;

    loadChat(currentChatSIM);
}

/* ===== INIT ===== */
home();
</script>

</body>
</html>
